# 実装仕様書 (2025-12-07 現在)

## 1. プロジェクト概要
**Node Modular** は、ブラウザ上で動作するモジュラーシンセサイザーアプリケーションです。
ノードベースのUIを使用して、オシレーター、フィルター、エンベロープなどのオーディオモジュールを自由に接続し、音響合成を行うことができます。

### 技術スタック
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **UIライブラリ**: Material UI (MUI), Emotion
- **ノードグラフ**: React Flow
- **オーディオエンジン**: Tone.js

## 2. システムアーキテクチャ

### 2.1 コアコンポーネント
- **NodeEditor (`src/components/NodeEditor.tsx`)**:
  - React Flowを使用したメインの編集画面。
  - ノードとエッジの状態管理（`useNodesState`, `useEdgesState`）。
  - ノードの追加・削除、テンプレートの適用を管理。
  - `AudioNodeManager` へのブリッジとして機能。

- **AudioNodeManager (`src/utils/AudioNodeManager.ts`)**:
  - シングルトンクラスとして実装。
  - Tone.jsのオーディオノードのインスタンス管理。
  - React Flowの接続情報（Edge）に基づいたオーディオルーティングの構築。
  - **自動スケーリング機能**: Control信号（LFOやエンベロープなど）をAudioParam（周波数など）に接続する際、定義された最小値・最大値に基づいて自動的に `Tone.Scale` を挿入し、信号レベルを適切に変換します。

### 2.2 データフロー
1. **ユーザー操作**: ノードの追加、パラメータ変更、結線。
2. **React State更新**: React Flowの `nodes`, `edges` が更新される。
3. **副作用フック**: 各ノードコンポーネントの `useEffect` が発火。
4. **オーディオ登録**: `registerAudioNode` が呼ばれ、`AudioNodeManager` に Tone.js ノードとパラメータ範囲情報が渡される。
5. **ルーティング再構築**: `AudioNodeManager` がすべての接続を走査し、必要に応じて `Tone.Scale` を挟みながら再接続を行う。

## 3. モジュール一覧 (`src/modules/`)

| モジュール名 | ファイル名 | 機能概要 | 主要パラメータ/入出力 |
|Str|Str|Str|Str|
| **VCO** | `NodeVCO.tsx` | 電圧制御発振器 | 波形(Sine, Square, Tri, Saw), 周波数 (20-2000Hz) |
| **Filter** | `NodeFilter.tsx` | フィルター | Cutoff Freq (200-5000Hz), Q (0.1-20) |
| **LFO** | `NodeLFO.tsx` | 低周波発振器 | 周波数 (0.1-20Hz), 振幅 (0-1) |
| **Amp Envelope** | `NodeAmplitudeEnvelope.tsx` | 振幅エンベロープ | ADSR (Attack, Decay, Sustain, Release) |
| **Freq Envelope** | `NodeFrequencyEnvelope.tsx` | 周波数変調用エンベロープ | ADSR + Min/Max Frequency |
| **Sequencer** | `NodeSequencer.tsx` | ステップシーケンサー | Step数, Tempo, Note/Gate出力 |
| **Delay** | `NodeDelay.tsx` | ディレイエフェクト | Time, Feedback, Wet |
| **Reverb** | `NodeReverb.tsx` | リバーブエフェクト | Room Size, Dampening |
| **Oscilloscope** | `NodeOscilloscope.tsx` | 波形表示 | 入力信号の波形を可視化 |
| **Output** | `NodeOutput.tsx` | 最終出力 | メインボリューム (-60dB - 0dB), `Tone.Destination` へ接続 |

## 4. 特記事項

### 4.1 シグナル種別の分離
接続（Edge）は以下の属性を持ち、信号の種類を識別します。
- `audio`: 通常のオーディオ信号の流れ。
- `control`: パラメータ変調用の制御信号（CV）。

### 4.2 テンプレート機能
- `src/modules/TemplateSelector.tsx` に定義。
- 一般的なパッチング（VCO -> Envelope -> Output など）をプリセットとして提供し、ワンクリックで展開可能。

### 4.3 既知の制約・挙動
- **オーディオコンテキスト**: ブラウザの自動再生ポリシーに対応するため、ユーザーインタラクション（VCOのStartボタン等）をトリガーに `Tone.start()` を呼び出す実装になっています。
- **再接続**: 現状の実装では、エッジの変更時に該当ノードに関連する接続が再評価されます。

---
*作成日: 2025-12-07*
